---
import MainLayout from '../layouts/MainLayout.astro';
import Pagination from '../components/Pagination.astro';
import { getCollection } from 'astro:content';
import { siteConfig } from '../data/site';
import { sortBlogByDateDesc, formatBlogDateTime } from '../lib/blog';

const PER_PAGE = 8;
const allPosts = (await getCollection('blog')).sort(sortBlogByDateDesc);
const total = allPosts.length;
const totalPages = Math.ceil(total / PER_PAGE) || 1;
const posts = allPosts.slice(0, PER_PAGE);

function excerpt(body: string | undefined, fallback: string, maxWords = 15): string {
  if (body && body.trim()) {
    const words = body.replace(/#+\s*|\[([^\]]*)\]\([^)]*\)|\*\*?[^*]*\*\*?/g, '$1').split(/\s+/).filter(Boolean);
    return words.length > maxWords ? words.slice(0, maxWords).join(' ') + '…' : words.join(' ');
  }
  return fallback || '';
}

function readingTime(body: string | undefined): number {
  if (!body) return 1;
  const words = body.split(/\s+/).filter(Boolean).length;
  return Math.max(1, Math.ceil(words / 250));
}
---
<MainLayout title={siteConfig.title}>
  {posts.map((post) => {
    const slug = post.id;
    const excerptText = excerpt(post.body, post.data.description ?? '', 15);
    const minutes = readingTime(post.body);
    return (
      <article class="post">
        {post.data.img && (
          <a
            class="post-thumbnail"
            style={`background-image: url(/assets/img/${post.data.img})`}
            href={`/${slug}/`}
          />
        )}
        <div class="post-content">
          <h2 class="post-title">
            <a href={`/${slug}/`}>{post.data.title}</a>
          </h2>
          <p>{excerptText}</p>
          <span class="post-date">{formatBlogDateTime(post.data.date)}&nbsp;&nbsp;&nbsp;—&nbsp;</span>
          <span class="post-words">{minutes} minute read</span>
        </div>
      </article>
    );
  })}
  <Pagination currentPage={1} totalPages={totalPages} basePath="/" />
</MainLayout>
